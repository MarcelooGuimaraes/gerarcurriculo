<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1" />
<title>Gerador de Currículo — Ferramenta</title>

<!-- Fonts (preconnect for performance) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Merriweather:wght@700&display=swap" rel="stylesheet">

<!-- html2pdf (CDN) para exportar PDF estilizado -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  /* ---------- Página (com identidade Renova) ---------- */
  :root{
    --renova-blue:#0b5394;
    --renova-green:#22b14c;
    --page-bg:#f3f6fa;
    --muted:#5b6b7a;
    --cv-pad:18px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--page-bg); color:#0b1b2b; -webkit-font-smoothing:antialiased;}

  /* Dark mode variables (applied when body.dark is present) */
  body.dark{ background:#0b1116; color:#dfe8ef }
  body.dark header.sitebar{ filter:brightness(.95) }

  header.sitebar{display:flex;align-items:center;gap:14px;padding:14px 20px;background:linear-gradient(135deg,var(--renova-blue),var(--renova-green));color:white;box-shadow:0 4px 18px rgba(2,6,23,.12);}
  header.sitebar img.logo{height:40px;border-radius:6px}
  header.sitebar h1{font-size:1.05rem;letter-spacing:.6px;margin:0;font-weight:700}
  .top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{border:0;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.ghost{background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.12)}
  .container{max-width:1200px;margin:22px auto;display:grid;grid-template-columns:360px 1fr;gap:18px;padding:0 16px}
  @media(max-width:980px){.container{grid-template-columns:1fr}}

  /* ---------- Painel do formulário (preservado) ---------- */
  .panel{background:white;border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(2,6,23,.06)}
  .panel h2{font-family:Merriweather,serif;margin:0 0 10px;font-size:1.1rem}
  label.field{display:block;margin-top:10px;font-size:0.95rem}
  input[type="text"], input[type="email"], input[type="tel"], textarea, input[type="url"]{
    width:100%;padding:10px;border-radius:8px;border:1px solid #d5dbe3;margin-top:6px;font-size:0.95rem;background:transparent;color:inherit
  }
  textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:8px}
  .small{font-size:0.85rem;color:var(--muted)}
  .control-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .kbtn{background:var(--renova-blue);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .kbtn.secondary{background:#eef3fb;color:var(--renova-blue);border:1px solid #d7e3f3}
  .mic{background:#ef4444;color:#fff;border:0;padding:6px 8px;border-radius:8px;cursor:pointer}
  .listen{background:#111;color:#fff;padding:6px 8px;border-radius:8px;border:0;cursor:pointer}

  .section-ops{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .section-ops .title{font-weight:700}
  .remove-section{background:#d33;color:#fff;border:0;padding:6px 8px;border-radius:8px;cursor:pointer}

  /* dynamic blocks */
  .dynamic-block{border:1px solid #eef3f6;padding:10px;border-radius:10px;margin-top:10px;background:#fcfeff}
  .dynamic-block .row{margin-top:8px}
  .remove-item{background:#f97316;color:#fff;border:0;padding:6px 8px;border-radius:8px;cursor:pointer}

  /* ---------- Preview / CV (ajustado) ---------- */
  .preview-wrap{padding:12px}
  .preview{background:white;border-radius:12px;padding:18px;box-shadow:0 10px 40px rgba(2,6,23,.06);}

  /* ---------- CV Preview Melhorado (base para os templates) ---------- */
  #cvPreview{ width:100%; box-sizing:border-box; font-family:Inter,system-ui, -apple-system, 'Segoe UI', Roboto, Arial; color:#0b1b2b; }

  /* Top */
  #cvPreview .cv-top{ display:flex; gap:20px; align-items:center; padding-bottom:12px; border-bottom:2px solid #eef2f6; }
  #cvPreview .cv-photo{ width:150px; height:150px; border-radius:50%; object-fit:cover; border:5px solid #ffffff; box-shadow:0 8px 26px rgba(2,6,23,.12); background:linear-gradient(135deg,#e6eefb,#e9fbef); flex-shrink:0 }
  #cvPreview .cv-name{ font-family:Merriweather,serif; font-size:2.1rem; margin:0; line-height:1; font-weight:800; color:#0b3b66 }
  #cvPreview .cv-role{ color:var(--renova-blue); font-weight:700; margin-top:6px; font-size:1.05rem; }

  #cvPreview .cv-contacts{ margin-top:10px; color:var(--muted); font-size:0.95rem; display:flex; gap:12px; flex-wrap:wrap; }

  /* grid content */
  #cvPreview .cv-grid{ display:grid; grid-template-columns: 2fr 1fr; gap:22px; margin-top:18px; align-items:start; }

  /* sections */
  #cvPreview .cv-section{ margin-bottom:14px; }
  #cvPreview .cv-section h3{ margin:0 0 8px 0; font-size:0.95rem; color:#0b3b66; letter-spacing:.06em; text-transform:uppercase; background:linear-gradient(90deg, rgba(11,83,148,0.04), transparent); padding:8px 10px; border-radius:6px; border-bottom:2px solid #e6eefb; }
  #cvPreview .cv-section p, #cvPreview .cv-section li{ font-size:0.95rem; color:#1e2937; line-height:1.45; margin:6px 0; }
  #cvPreview .xp-meta{ font-size:0.88rem; color:#64748b; margin-top:4px; }
  #cvPreview .xp-title{ font-weight:700; font-size:1rem; color:#0b1b2b; }

  /* tags */
  #cvPreview .tag{ display:inline-block; padding:6px 12px; border-radius:999px; color:white; font-weight:700; margin:6px 6px 6px 0; background:linear-gradient(90deg,var(--renova-blue),var(--renova-green)); font-size:0.85rem; }

  /* Template: Classic = template-1 (default) */
  #cvPreview.template-1 .cv-top{border-color:#e6eefb;}
  #cvPreview.template-1 .cv-photo{border-color:#ffffff;}

  /* Template: Minimal (centered header) */
  #cvPreview.template-2 .cv-top{ flex-direction:column; align-items:center; text-align:center; border-bottom:2px solid #f3f4f6; }
  #cvPreview.template-2 .cv-grid{ grid-template-columns: 1fr; margin-top:14px; }
  #cvPreview.template-2 .cv-section h3{ background:transparent; border-bottom:1px solid #eef2f6; padding:0 0 8px 0; text-align:left; }

  /* Template: Creative (sidebar) - FIXED layout to avoid overflow */
  #cvPreview.template-3{ display:grid; grid-template-columns: 280px 1fr; gap:0; align-items:start; width:100%; }
  #cvPreview.template-3 .sidebar{ background:linear-gradient(180deg,var(--renova-blue),var(--renova-green)); color:white; padding:26px; min-height:100%; box-sizing:border-box; }
  #cvPreview.template-3 .sidebar .cv-photo{ width:140px; height:140px; border:4px solid rgba(255,255,255,0.18); background:transparent; object-fit:cover }
  #cvPreview.template-3 .main{ padding:26px; }

  /* ensure images and content don't overflow preview area */
  .preview img{ max-width:100%; height:auto; display:block }
  #cvPreview{ max-width:100%; }

  /* print tweaks - ensure page fits A4 */
  @media print{
    body{background:white}
    header.sitebar,.panel{display:none}
    .preview{box-shadow:none}
    #cvPreview{ width:210mm; box-sizing:border-box; padding:var(--cv-pad); }
    #cvPreview .cv-photo{ width:160px; height:160px; }
    #cvPreview.template-3{ display:block } /* fallback */
  }

  /* small screens */
  @media(max-width:780px){
    #cvPreview .cv-photo{ width:110px; height:110px; }
    #cvPreview .cv-name{ font-size:1.4rem; }
    .container{ grid-template-columns: 1fr; }
    #cvPreview.template-3{ display:block }
    #cvPreview.template-3 .sidebar{ padding:16px }
    #cvPreview.template-3 .main{ padding:16px }
  }
</style>
</head>
<body>

<!-- HEADER com identidade Renova (presente na página, mas NÃO no currículo exportado) -->
<header class="sitebar" role="banner" aria-label="Barra superior Renova">
  <img class="logo" src="https://opiniaobrasilia.com.br/wp-content/uploads/2020/12/RenovaDF.jpeg" alt="Renova DF">
  <h1>Renova DF — Gerador de Currículos</h1>
  <div class="top-actions" role="navigation" aria-label="Ações principais">
    <button class="btn ghost" id="themeToggle" title="Alternar tema">Tema</button>
    <button class="btn kbtn" id="exportPDF" title="Exportar currículo como PDF">Exportar PDF</button>
  </div>
</header>

<!-- LAYOUT -->
<div class="container" role="main">

  <!-- Painel esquerdo: formulário -->
  <aside class="panel" aria-label="Formulário de preenchimento">
    <h2>Dados do candidato</h2>

    <label class="field">Nome
      <input id="nameInput" type="text" aria-label="Nome completo do candidato" placeholder="Ex.: Maria Silva">
      <div class="small"> <button class="mic" onclick="startDictationFor('nameInput')" aria-label="Ditado do nome">🎤</button>
      <button class="listen" onclick="speakField('nameInput','Digite o nome completo')">🔊</button></div>
    </label>

    <label class="field">Cargo
      <input id="roleInput" type="text" aria-label="Cargo desejado" placeholder="Ex.: Coordenador de Obras">
      <div class="small"> <button class="mic" onclick="startDictationFor('roleInput')">🎤</button>
      <button class="listen" onclick="speakField('roleInput','Digite o cargo desejado')">🔊</button></div>
    </label>

    <div class="row">
      <label class="field" style="flex:1">Telefone
        <input id="phoneInput" type="tel" aria-label="Telefone" placeholder="+55 (61) 9XXXX-XXXX">
        <button class="mic" onclick="startDictationFor('phoneInput')">🎤</button>
      </label>

      <label class="field" style="flex:1">Email
        <input id="emailInput" type="email" aria-label="Email" placeholder="seuemail@exemplo.com">
        <button class="mic" onclick="startDictationFor('emailInput')">🎤</button>
      </label>
    </div>

    <label class="field">Cidade
      <input id="cityInput" type="text" aria-label="Cidade e estado" placeholder="Brasília, DF">
      <button class="mic" onclick="startDictationFor('cityInput')">🎤</button>
    </label>

    <label class="field">LinkedIn / Site
      <input id="siteInput" type="url" aria-label="Site ou Linkedin" placeholder="https://">
    </label>

    <label class="field">Resumo profissional
      <textarea id="summaryInput" aria-label="Resumo profissional" placeholder="Escreva 2–5 linhas resumindo sua experiência, foco e resultados."></textarea>
      <div class="small"><button class="mic" onclick="startDictationFor('summaryInput')">🎤</button>
      <button class="listen" onclick="speakField('summaryInput','Fale ou digite um resumo profissional em 3 a 5 linhas')">🔊</button></div>
    </label>

    <label class="field">Foto (recomendo 400x400) <small style="display:block;color:var(--muted)">Escolha arquivo (evita CORS ao exportar)</small>
      <input id="photoInput" type="file" accept="image/*" aria-label="Enviar foto do candidato">
    </label>

    <label class="field">Habilidades (separe por vírgula)
      <input id="skillsInput" type="text" aria-label="Lista de habilidades" placeholder="ex.: Comunicação, Planejamento, AutoCAD">
    </label>

    <div style="margin-top:12px" class="section-ops">
      <div class="title">Seções dinâmicas</div>
      <div class="small">Adicione ou remova seções inteiras</div>
    </div>

    <!-- Buttons para adicionar seções -->
    <div class="control-actions" aria-hidden="false" style="margin-top:8px;">
      <button class="kbtn secondary" onclick="addSection('experience')" id="addExpBtn">+ Experiência</button>
      <button class="kbtn secondary" onclick="addSection('education')" id="addEduBtn">+ Formação</button>
      <button class="kbtn secondary" onclick="addSection('certs')" id="addCertBtn">+ Certificações</button>
      <button class="kbtn secondary" onclick="addSection('langs')" id="addLangBtn">+ Idiomas</button>
    </div>

    <!-- Contêineres dinâmicos de seções (os itens são adicionados dentro destes) -->
    <div id="sectionsArea" style="margin-top:14px"></div>

    <!-- Template selector -->
    <div style="margin-top:14px">
      <label class="field">Modelo de currículo
        <select id="templateSelect" aria-label="Selecionar modelo de currículo">
          <option value="template-1">Modelo 1 — Clássico</option>
          <option value="template-2">Modelo 2 — Minimalista</option>
          <option value="template-3">Modelo 3 — Moderno (sidebar)</option>
        </select>
      </label>
    </div>

    <div class="control-actions" style="margin-top:16px">
      <button class="kbtn" id="updateBtn">Atualizar preview</button>
      <button class="kbtn secondary" id="clearBtn">Limpar tudo</button>
      <button class="kbtn secondary" id="loadExampleBtn" title="Preencher com exemplo">Carregar Exemplo</button>
    </div>

    <p class="small" style="margin-top:12px">Dica: use 🎤 para ditar. Para exportar, clique em "Exportar PDF". A exportação inclui somente o currículo (sem header Renova).</p>
  </aside>

  <!-- Painel direito: preview (o currículo em si) -->
  <main class="preview-wrap" aria-label="Pré-visualização do currículo">
    <div id="cvPreview" class="preview template-1" role="region" aria-live="polite" aria-label="Visualização do currículo">
      <div id="cvContent" style="padding:18px">
        <!-- Conteúdo do currículo renderizado aqui -->
      </div>
    </div>
  </main>
</div>

<script>
/* ---------- Voz: leitura + ditado ---------- */
function speakField(id, hint){
  const v = (document.getElementById(id)?.value) || hint || '';
  const u = new SpeechSynthesisUtterance(v);
  u.lang='pt-BR';
  window.speechSynthesis.speak(u);
}
function startDictationFor(id){
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
    alert('Reconhecimento de voz não suportado neste navegador. Use Chrome/Edge.');
    return;
  }
  const Rec = window.webkitSpeechRecognition || window.SpeechRecognition;
  const recognition = new Rec();
  recognition.lang = 'pt-BR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.start();
  recognition.onresult = (ev) => {
    const text = ev.results[0][0].transcript;
    const el = document.getElementById(id);
    if(el){
      if(el.tagName.toLowerCase()==='textarea') el.value = (el.value? el.value + ' ' : '') + text;
      else el.value = text;
      rebuildPreview();
    }
  };
}

/* ---------- Dinâmica de seções ---------- */
const sectionsArea = document.getElementById('sectionsArea');
const sectionsState = { experience:false, education:false, certs:false, langs:false };

function addSection(name){
  if(sectionsState[name]) return;
  sectionsState[name] = true;

  const wrapper = document.createElement('div');
  wrapper.className = 'panel';
  wrapper.id = `section-${name}`;
  wrapper.style.marginTop = '12px';

  const titleMap = { experience:'Experiência Profissional', education:'Formação Acadêmica', certs:'Certificações & Cursos', langs:'Idiomas' };

  wrapper.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${titleMap[name]}</strong><div class="small">Adicione itens — cada item representa uma entrada</div></div>
      <div><button class="remove-section" aria-label="Remover seção" title="Remover seção" data-sec="${name}">Remover seção</button></div>
    </div>
    <div id="${name}-items" style="margin-top:10px"></div>
    <div style="margin-top:8px"><button class="kbtn secondary" data-add="${name}">+ Adicionar item</button></div>
  `;
  sectionsArea.appendChild(wrapper);

  // add first item
  addItemToSection(name);

  wrapper.querySelector('[data-add="'+name+'"]').addEventListener('click', ()=> addItemToSection(name));
  wrapper.querySelector('.remove-section').addEventListener('click', (e)=> { removeSection(e.currentTarget.dataset.sec); });

  rebuildPreview();
}

function removeSection(name){
  sectionsState[name] = false;
  const el = document.getElementById('section-'+name);
  if(el) el.remove();
  rebuildPreview();
}

function addItemToSection(name){
  const container = document.getElementById(name+'-items');
  const id = name + '-' + Math.random().toString(36).slice(2,9);
  const block = document.createElement('div');
  block.className = 'dynamic-block';
  block.dataset.blockId = id;

  let html = '';
  if(name === 'experience'){
    html = `
      <label class="field">Empresa <input id="${id}-company" type="text"></label>
      <label class="field">Cargo <input id="${id}-role" type="text"></label>
      <label class="field">Período <input id="${id}-period" type="text" placeholder="Ex.: 2020 — Atual"></label>
      <label class="field">Atividades / Resultados <textarea id="${id}-desc" placeholder="Separe por pontos ou parágrafos"></textarea></label>
    `;
  } else if(name === 'education'){
    html = `
      <label class="field">Instituição <input id="${id}-inst" type="text"></label>
      <label class="field">Curso <input id="${id}-course" type="text"></label>
      <label class="field">Período <input id="${id}-period" type="text"></label>
    `;
  } else if(name === 'certs'){
    html = `
      <label class="field">Título <input id="${id}-title" type="text"></label>
      <label class="field">Organização <input id="${id}-org" type="text"></label>
      <label class="field">Ano <input id="${id}-year" type="text"></label>
    `;
  } else if(name === 'langs'){
    html = `
      <label class="field">Idioma <input id="${id}-lang" type="text"></label>
      <label class="field">Nível <input id="${id}-level" type="text" placeholder="Básico / Intermediário / Avançado"></label>
    `;
  }

  block.innerHTML = html + `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
    <button class="remove-item" aria-label="Remover item">Remover item</button>
    <button class="mic" onclick="startDictationForBlock('${id}')">🎤</button>
    <button class="listen" onclick="speakBlock('${id}')">🔊</button>
    </div>`;

  container.appendChild(block);

  block.querySelector('.remove-item').addEventListener('click', ()=> { block.remove(); rebuildPreview(); });
  block.querySelectorAll('input,textarea').forEach(inp => inp.addEventListener('input', ()=> rebuildPreview()));

  rebuildPreview();
}

/* ---------- block-level speech helpers ---------- */
function startDictationForBlock(blockId){
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){ alert('Reconhecimento de voz não suportado.'); return; }
  const Rec = window.webkitSpeechRecognition || window.SpeechRecognition;
  const rec = new Rec();
  rec.lang='pt-BR'; rec.interimResults=false; rec.maxAlternatives=1;
  rec.start();
  rec.onresult = (ev) => {
    const text = ev.results[0][0].transcript;
    const el = document.querySelector(`[data-block-id="${blockId}"]`);
    if(!el) return;
    const target = el.querySelector('textarea') || el.querySelector('input');
    if(target){
      if(target.tagName.toLowerCase()==='textarea') target.value = (target.value? target.value + ' ' : '') + text;
      else target.value = text;
      rebuildPreview();
    }
  };
}
function speakBlock(blockId){
  const el = document.querySelector(`[data-block-id="${blockId}"]`);
  if(!el) return;
  const labels = [...el.querySelectorAll('label')].map(l => l.childNodes[0]?.textContent?.trim()).filter(Boolean);
  const u = new SpeechSynthesisUtterance(labels.join('. '));
  u.lang='pt-BR'; speechSynthesis.speak(u);
}

/* ---------- photo handling ---------- */
let photoDataUrl = '';
document.getElementById('photoInput').addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => { photoDataUrl = ev.target.result; rebuildPreview(); };
  reader.readAsDataURL(f);
});

/* ---------- template switching ---------- */
document.getElementById('templateSelect').addEventListener('change', (e)=>{
  const t = e.target.value;
  const preview = document.getElementById('cvPreview');
  preview.classList.remove('template-1','template-2','template-3');
  preview.classList.add(t);
  rebuildPreview();
});

/* ---------- clear / example / update ---------- */
document.getElementById('updateBtn').addEventListener('click', rebuildPreview);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!confirm('Limpar todos os campos e seções?')) return;
  document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], textarea, input[type="url"]').forEach(i=> i.value='');
  photoDataUrl = '';
  sectionsArea.innerHTML = '';
  for(const k in sectionsState) sectionsState[k]=false;
  document.getElementById('templateSelect').value='template-1';
  document.getElementById('cvPreview').className='preview template-1';
  rebuildPreview();
});
document.getElementById('loadExampleBtn').addEventListener('click', loadExample);

/* ---------- build preview: core rendering logic ---------- */
function rebuildPreview(){
  const name = document.getElementById('nameInput').value.trim() || 'Nome Completo';
  const role = document.getElementById('roleInput').value.trim() || 'Cargo / Área';
  const phone = document.getElementById('phoneInput').value.trim() || '';
  const email = document.getElementById('emailInput').value.trim() || '';
  const city = document.getElementById('cityInput').value.trim() || '';
  const site = document.getElementById('siteInput').value.trim() || '';
  const summary = document.getElementById('summaryInput').value.trim() || 'Resumo profissional: destaque breve sobre experiência, foco e resultados.';
  const skillsRaw = document.getElementById('skillsInput').value || '';
  const skills = skillsRaw.split(',').map(s=>s.trim()).filter(Boolean);
  const preview = document.getElementById('cvContent');
  const previewRoot = document.getElementById('cvPreview');
  const activeTemplate = previewRoot.classList.contains('template-2') ? 'template-2' : (previewRoot.classList.contains('template-3') ? 'template-3' : 'template-1');

  let html = '';

  if(activeTemplate === 'template-3'){
    // creative sidebar
    html = `
      <div class="sidebar" aria-hidden="true">
        <div style="display:flex;justify-content:center;"><img class="cv-photo" src="${photoDataUrl||''}" alt=""></div>
        <div style="text-align:center;margin-top:8px;font-weight:800;color:white">${escapeHtml(name)}</div>
        <div style="text-align:center;color:rgba(255,255,255,0.9);margin-bottom:12px">${escapeHtml(role)}</div>
        <div style="color:rgba(255,255,255,0.95);font-size:0.95rem;line-height:1.4">
          ${phone? `<div>${escapeHtml(phone)}</div>` : ''}${email? `<div>${escapeHtml(email)}</div>` : ''}${city? `<div>${escapeHtml(city)}</div>` : ''}
        </div>
        ${skills.length? `<div style="margin-top:16px"><div style="font-weight:800;margin-bottom:8px;color:rgba(255,255,255,0.95)">Habilidades</div>${skills.map(s=>`<div class="tag">${escapeHtml(s)}</div>`).join('')}</div>` : ''}
      </div>
      <div class="main">
        <div style="margin-bottom:10px"><h3 style="margin:0">Resumo</h3><p>${escapeHtml(summary)}</p></div>
        ${renderSectionHtml('experience')}
        ${renderSectionHtml('education')}
        ${renderSectionHtml('certs')}
        ${renderSectionHtml('langs')}
        <div style="margin-top:18px;text-align:right;color:#6b7280;font-size:.9rem">Atualizado em ${new Date().toLocaleDateString('pt-BR')}</div>
      </div>
    `;
  } else {
    // template 1 & 2: top left photo
    html = `
      <div class="cv-top">
        <img class="cv-photo" src="${photoDataUrl||''}" alt="">
        <div>
          <h1 class="cv-name">${escapeHtml(name)}</h1>
          <div class="cv-role">${escapeHtml(role)}</div>
          <div class="cv-contacts">${phone? `<span>${escapeHtml(phone)}</span>` : ''} ${email? `<span>• ${escapeHtml(email)}</span>` : ''} ${city? `<span>• ${escapeHtml(city)}</span>` : ''} ${site? `<span>• ${escapeHtml(site)}</span>` : ''}</div>
        </div>
      </div>

      <div class="cv-grid">
        <div>
          <div class="cv-section"><h3>Resumo</h3><p>${escapeHtml(summary)}</p></div>
          ${renderSectionHtml('experience')}
          ${renderSectionHtml('education')}
        </div>
        <aside>
          <div class="cv-section"><h3>Habilidades</h3><div>${skills.map(s=>`<span class="tag">${escapeHtml(s)}</span>`).join('')}</div></div>
          ${renderSectionHtml('certs')}
          ${renderSectionHtml('langs')}
          <div style="margin-top:16px;color:#6b7280;font-size:.9rem">Atualizado em ${new Date().toLocaleDateString('pt-BR')}</div>
        </aside>
      </div>
    `;
  }

  preview.innerHTML = html;
}

/* helper: renderSectionHtml reads the DOM inputs for that section and returns rendered HTML */
function renderSectionHtml(section){
  if(!sectionsState[section]) return '';
  const container = document.getElementById(section+'-items');
  if(!container) return '';
  const items = [...container.children];
  if(items.length === 0) return '';

  if(section === 'experience'){
    const parts = items.map(b=>{
      const c = b.querySelector('input[id$="-company"]')?.value || '';
      const r = b.querySelector('input[id$="-role"]')?.value || '';
      const p = b.querySelector('input[id$="-period"]')?.value || '';
      const d = b.querySelector('textarea[id$="-desc"]')?.value || '';
      if(!(c||r||d||p)) return '';
      return `<div class="cv-section"><div class="xp-title">${escapeHtml(r || c)}</div><div class="xp-meta">${escapeHtml(c)} ${p? '• ' + escapeHtml(p):''}</div>${d? `<p>${escapeHtml(d)}</p>`:''}</div>`;
    }).filter(Boolean).join('');
    return parts || '';
  }

  if(section === 'education'){
    const parts = items.map(b=>{
      const inst = b.querySelector('input[id$="-inst"]')?.value || '';
      const course = b.querySelector('input[id$="-course"]')?.value || '';
      const per = b.querySelector('input[id$="-period"]')?.value || '';
      if(!(inst||course)) return '';
      return `<div class="cv-section"><div class="xp-title">${escapeHtml(course)}</div><div class="xp-meta">${escapeHtml(inst)} ${per? '• ' + escapeHtml(per):''}</div></div>`;
    }).filter(Boolean).join('');
    return parts || '';
  }

  if(section === 'certs'){
    const parts = items.map(b=>{
      const title = b.querySelector('input[id$="-title"]')?.value || '';
      const org = b.querySelector('input[id$="-org"]')?.value || '';
      const year = b.querySelector('input[id$="-year"]')?.value || '';
      if(!title) return '';
      return `<div class="cv-section"><div class="xp-title">${escapeHtml(title)}</div><div class="xp-meta">${escapeHtml(org)} ${year? '• ' + escapeHtml(year):''}</div></div>`;
    }).filter(Boolean).join('');
    return parts || '';
  }

  if(section === 'langs'){
    const parts = items.map(b=>{
      const lang = b.querySelector('input[id$="-lang"]')?.value || '';
      const level = b.querySelector('input[id$="-level"]')?.value || '';
      if(!lang) return '';
      return `<div class="cv-section"><div class="xp-title">${escapeHtml(lang)}</div><div class="xp-meta">${escapeHtml(level)}</div></div>`;
    }).filter(Boolean).join('');
    return parts || '';
  }

  return '';
}

function escapeHtml(s){
  return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

/* ---------- Export to PDF (isolar apenas o currículo) ---------- */
function exportCurriculumAsPDF(){
  // ensure html2pdf is available
  if(typeof html2pdf === 'undefined'){
    alert('Ainda carregando a biblioteca de exportação. Tente novamente em alguns segundos.');
    return;
  }

  const el = document.getElementById('cvPreview');
  // clone and prepare
  const clone = el.cloneNode(true);
  // remove interactive elements inside clone
  clone.querySelectorAll('button, input, textarea, select').forEach(n=>n.remove());

  // force light mode in clone for consistent print (optional)
  clone.classList.remove('dark');

  const wrapper = document.createElement('div');
  wrapper.style.background = '#fff';
  wrapper.style.padding = '0';
  wrapper.style.margin = '0 auto';
  wrapper.style.width = '210mm'; // A4 width
  wrapper.style.boxSizing = 'border-box';
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);

  const filename = `${(document.getElementById('nameInput').value||'curriculo').replaceAll(' ','_')}.pdf`;
  const opt = {
    margin:       [10,10,10,10], // mm
    filename,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, allowTaint: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(wrapper).save().then(()=>{
    wrapper.remove();
  }).catch(err=>{
    console.error(err);
    alert('Erro ao exportar PDF: '+(err && err.message? err.message : err));
    wrapper.remove();
  });
}

document.getElementById('exportPDF').addEventListener('click', exportCurriculumAsPDF);

/* ---------- utility: load example (quick preview) ---------- */
function loadExample(){
  document.getElementById('nameInput').value = 'Ana Beatriz Costa';
  document.getElementById('roleInput').value = 'Coordenadora de Segurança do Trabalho';
  document.getElementById('phoneInput').value = '+55 (61) 9 9123-4567';
  document.getElementById('emailInput').value = 'ana.costa@example.com';
  document.getElementById('cityInput').value = 'Brasília, DF';
  document.getElementById('siteInput').value = 'https://linkedin.com/in/anacosta';
  document.getElementById('summaryInput').value = 'Especialista em segurança do trabalho com 8 anos de experiência em canteiros de obras, implementação de programas de prevenção e treinamentos. Foco em redução de incidentes e cultura de segurança.';
  document.getElementById('skillsInput').value = 'Segurança do Trabalho, EPI, Treinamentos, Gestão de Risco, Comunicação';

  if(!sectionsState.experience) addSection('experience');
  if(!sectionsState.education) addSection('education');
  if(!sectionsState.certs) addSection('certs');
  if(!sectionsState.langs) addSection('langs');

  const expItem = document.querySelector('#experience-items .dynamic-block');
  if(expItem){
    expItem.querySelector('input[id$="-company"]').value = 'Construtora BoaObra';
    expItem.querySelector('input[id$="-role"]').value = 'Coordenadora de Segurança';
    expItem.querySelector('input[id$="-period"]').value = '2019 — Atual';
    expItem.querySelector('textarea[id$="-desc"]').value = 'Implementação de programa de prevenção; redução de acidentes em 35%; treinamento de 120 colaboradores.';
  }
  const eduItem = document.querySelector('#education-items .dynamic-block');
  if(eduItem){
    eduItem.querySelector('input[id$="-inst"]').value = 'Universidade de Brasília (UnB)';
    eduItem.querySelector('input[id$="-course"]').value = 'Pós-graduação em Segurança do Trabalho';
    eduItem.querySelector('input[id$="-period"]').value = '2017 — 2019';
  }
  const certItem = document.querySelector('#certs-items .dynamic-block');
  if(certItem){
    certItem.querySelector('input[id$="-title"]').value = 'NR-35 — Trabalho em Altura';
    certItem.querySelector('input[id$="-org"]').value = 'SESI';
    certItem.querySelector('input[id$="-year"]').value = '2021';
  }
  const langItem = document.querySelector('#langs-items .dynamic-block');
  if(langItem){
    langItem.querySelector('input[id$="-lang"]').value = 'Inglês';
    langItem.querySelector('input[id$="-level"]').value = 'Intermediário';
  }

  rebuildPreview();
}

/* ---------- init: listeners and defaults ---------- */
['nameInput','roleInput','phoneInput','emailInput','cityInput','siteInput','summaryInput','skillsInput'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', () => rebuildPreview());
});

// start with experience and education sections to help users
addSection('experience');
addSection('education');

// theme persistence: restore saved theme
(function(){
  try{
    const t = localStorage.getItem('cv_theme');
    if(t === 'dark') document.body.classList.add('dark');
  }catch(e){/* ignore */}
})();

// theme toggle (page-level only)
document.getElementById('themeToggle').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  try{ localStorage.setItem('cv_theme', document.body.classList.contains('dark')? 'dark' : 'light'); }catch(e){}
});

// initial render
rebuildPreview();

// **Gerar exemplo automaticamente conforme solicitado**
loadExample();
</script>
</body>
</html>
